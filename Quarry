cfgLocation = "Quarry.cfg"
ignoreLocation = "IgnoreBlocks"
saveLocation = "Quarry.sav"
os.loadAPI("API/movement")

local function digUpDown()
    a,b = turtle.inspectUp()
    if a and ignoreBlocks[b["name"]] == nil then
        turtle.digUp()
    end
    a,b = turtle.inspectDown()
    if a and ignoreBlocks[b["name"]] == nil then
        turtle.digDown()
    end
end

local function save()
    local f = fs.open(saveLocation, "w")
    f.writeLine(movement.getX())
    f.writeLine(movement.getY())
    f.writeLine(movement.getZ())
    f.writeLine(width)
    f.close()
end

local function goHome()
    lastPosX = movement.getX()
    lastPosY = movement.getY()
    lastPosZ = movement.getZ()
    lastHeading = movement.getHeading()
    movement.gotoX(0)
    movement.gotoZ(0)
    movement.gotoY(0)
end

local function goBack()
    movement.gotoY(lastPosY)
    movement.gotoZ(lastPosZ)
    movement.gotoX(lastPosX)
    movement.turnTo(lastHeading)
end

local function attemptRefuel()
    for i = 1,16 do
        if turtle.getItemCount(i) > 0 then
            turtle.select(i)
            if turtle.refuel(0) then
                turtle.refuel(turtle.getItemCount())
            end
        end
    end
end

local function placeEnderChest()
    while turtle.detect() do
        turtle.dig()
    end
    for i =1,16 do
        if turtle.getItemCount() > 0 then
            info = turtle.getItemDetail(i)
            if info["name"] == "EnderStorage:enderChest" then
                turtle.select(i)
                turtle.place()
            end
        end
    end
end

local function dropAll()
    if turtle.detect() then
        for i=1,16 do
            if turtle.getItemCount(i) > 0 then
                turtle.select(i)
                while not turtle.drop() do
                    if cfg.extraChests then
                        movement.up(true)
                        while not turtle.detect() do
                            error.post("Missing drop chest2", true)
                        end
                    elseif cfg.enderChest then
                        -- Wait for extraction
                        sleep(10)
                    else
                        error.post("Drop chest full", true)
                    end
                end
            end
        end
    end
end

local function emptyInventoryIntoChest()
    if cfg.enderChest then
        placeEnderChest()
    else
        goHome()
        movement.turnTo(1)
    end
    -- Check for initial chest
    while not turtle.detect() do
        error.post("Missing drop chest1", true)
    end
    dropAll()
    if not cfg.enderChest then
        goBack()
    end    
end

local function getFuel()
    goHome()
    -- While were here, store stuff
    if not cfg.enderChest then
        movement.turnTo(1)
        emptyInventoryIntoChest()
    end
    movement.turnTo(2)
    while turtle.getFuelLevel() < getMinFuel() do
        while not turtle.suck() do
            error.post("Not enough fuel", true)
        end
        attemptRefuel()
    end
    goBack()
end

local function slotsOfInventoryUsed()
    sum = 0
    for i = 1,16 do
        if turtle.getItemCount(i) > 0 then
            sum = sum + 1
        end
    end
    return sum
end

local function getMinFuel()
    return width ^ 2 + width + 100
end

local function checkStuff()
    if slotsOfInventoryUsed() == 16 then
        if cfg.drop then
            for i = 1,16 do
                if turtle.getItemCount(i) > 0 then
                    turtle.select(i)
                    a = turtle.getItemDetail()
                    if ignoreBlocks[a["name"]] then
                        turtle.drop()
                    end
                end
            end
            turtle.select(1)
        else
            emptyInventoryIntoChest()
        end
    end
    if turtle.getFuelLevel() < getMinFuel() then
        attemptRefuel()
        if turtle.getFuelLevel() < getMinFuel() then
            getFuel()
        end
    end
end

local function dig()
    digUpDown()
    movement.forward(true)
    if cfg.reboot then save() end
    checkStuff()
end

local function doColumn()
    while true do
        dig()
        if movement.getZ() == -width + 1 or movement.getZ() == 0 then 
            return 
        end
    end
end

local function clearLevel()
    digUpDown()
    while true do
        up = ((movement.getX() % 2) == 0)
        doColumn()
        if movement.getX() == width - 1 then
            digUpDown()
            movement.gotoX(0)
            movement.gotoZ(0)
            movement.turnTo(0)
            return
        end
        movement.turnTo(3)
        dig()
        if up then 
            movement.turnTo(2)
        else
            movement.turnTo(0)
        end
        dig()
    end
end

local function editStartup()
    local f = fs.open("startup", "w")
    f.writeLine("shell.run(\"Quarry2\", \"-r\")")
    f.close()
end

local function loadConfig()
    if not fs.exists(cfgLocation) then
        print("Loading config")
        shell.run("SetupQuarry")
    else
        print("Loading config")
        shell.run("SetupQuarry", "-l")
    end
end

local function loadIgnoreBlocks()
    ignoreBlocks = {}
    if not fs.exists(ignoreLocation) then
        print("There is no IgnoreBlocks file, please run the teach program first")
        return
    end
    file = fs.open(ignoreLocation,"r")
    while true do
        text = file.readLine()
        if text == nil then break end
        ignoreBlocks[text] = true
    end
end

local function load()
    os.loadAPI("API/movement")
    loadConfig()
    loadIgnoreBlocks()
    if cfg.reboot then
        editStartup()
    end

    -- Select the first slot so that items dug will be put there
    turtle.select(1)
    -- Set fuel settings in the movement API
    movement.setCallback(function() return 10 end, function() return 10 end)
end

local function go()
    while movement.getY() < 0 do
        clearLevel()
        for i=1,3 do
            movement.up(true)
            checkStuff()
        end
    end
    emptyInventoryIntoChest()
    if cfg.reboot then
        fs.delete("startup")
        fs.delete(saveLocation)
    end
end

local function start()
    -- Head down to the bottom of the map
    while movement.down(true) do checkStuff() end
    movement.up(true)
    go()
end

local function reboot()
    movement.init()
    local f = fs.open(saveLocation, "r")
    lx = tonumber(f.readLine())
    ly = tonumber(f.readLine())
    lz = tonumber(f.readLine())
    width = tonumber(f.readLine())
    f.close()

    checkStuff()
    movement.gotoY(ly)
    movement.gotoZ(lz)
    movement.gotoX(lx)
    go()
end

local args = {...}
load()
if #args == 1 and args[1] == "-r" then
    reboot()
    return
elseif #args == 1 then
    width = tonumber(args[1])
elseif #args == 0 then
    width = 8
else
    printUsage()
    return
end
start()